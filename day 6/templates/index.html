<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GigaChat Assistant</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="page">
    <header class="header">
      <div>
        <h1 class="title">–ü–æ–º–æ—â–Ω–∏–∫ –Ω–∞ –≤—Å–µ —Ä—É–∫–∏</h1>
        <p class="subtitle">–í–µ–±-–≤–µ—Ä—Å–∏—è –ø–æ–º–æ—â–Ω–∏–∫–∞ –Ω–∞ –±–∞–∑–µ GigaChat</p>
      </div>
    </header>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-list">
          {% for category, message in messages %}
            <div class="flash flash-{{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <main class="content">
      <section class="chat-panel">
        <div class="chat-card rounded-card">
          {% if history %}
            <div class="chat-log" id="chat-log">
              {% for item in history %}
                {% if item.role == 'assistant' %}
                  <div class="bubble bubble-{{ item.role }}">
                    <div class="bubble-meta">
                      –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä
                    </div>
                    <div class="bubble-text">{{ item.content | e | replace('\n', '<br>') | safe }}</div>
                    {% if item.meta %}
                      <div class="bubble-meta-details">
                        {{ providers[item.meta.provider].title }} ‚Ä¢ {{ item.meta.model }} ¬∑
                        ‚è± {{ item.meta.elapsed | float | round(2) }} c ¬∑
                        üî¢ {{ item.meta.tokens if item.meta.tokens is not none else '‚Äî' }} —Ç–æ–∫–µ–Ω–æ–≤
                      </div>
                    {% endif %}
                  </div>
                {% else %}
                  <div class="bubble bubble-{{ item.role }}">
                    <div class="bubble-meta">
                      –í—ã
                    </div>
                    <div class="bubble-text">{{ item.content | e | replace('\n', '<br>') | safe }}</div>
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          {% else %}
            <div class="chat-empty">
              <p>–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥ ‚Äî –∑–∞–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –æ–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É.</p>
            </div>
          {% endif %}
        </div>

        <form method="post" class="composer-bar rounded-card" id="composer-form">
          <input type="hidden" name="preset" id="composer-preset" value="{{ state.preset_key }}">
          <input type="hidden" name="provider" id="composer-provider" value="{{ state.provider }}">
          <input type="hidden" name="model" id="composer-model" value="{{ state.model }}">
          <input type="hidden" name="temperature" id="composer-temperature" value="{{ '%.2f'|format(state.temperature) }}">

          <textarea
            name="message"
            class="composer-bar-input"
            rows="1"
            placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
          ></textarea>
          <button type="submit" name="action" value="send" class="composer-send" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
            ‚û§
          </button>
          <button type="submit" name="action" value="reset" class="btn tiny">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </form>
      </section>

      <section class="controls rounded-card">
        <form method="post" class="controls-form">
          <div class="field-grid">
            <div class="field">
              <label for="provider">–ü—Ä–æ–≤–∞–π–¥–µ—Ä</label>
              <select id="provider" name="provider" class="input">
                {% for key, provider in providers.items() %}
                  <option value="{{ key }}" {% if key == state.provider %}selected{% endif %}>
                    {{ provider.title }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="field">
              <label for="preset">–ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–∫–∞</label>
              <select id="preset" name="preset" class="input">
                {% for key, preset in presets.items() %}
                  <option value="{{ key }}" {% if key == state.preset_key %}selected{% endif %}>
                    {{ preset.name }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="field">
              <label for="model">–ú–æ–¥–µ–ª—å</label>
              <select id="model" name="model" class="input">
                {% for model_key, model_info in models.items() %}
                  <option value="{{ model_key }}" {% if model_key == state.model %}selected{% endif %}>
                    {{ model_info.label }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="field">
              <label for="temperature">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (0.00 ‚Äì 2.00)</label>
              <input
                id="temperature"
                name="temperature"
                type="number"
                class="input"
                min="0"
                max="2"
                step="0.05"
                value="{{ '%.2f'|format(state.temperature) }}"
              >
            </div>
          </div>

          <section class="prompt-preview">
            <div class="preview-header">
              <h2>–¢–µ–∫—É—â–∏–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç</h2>
              <span class="current-model">{{ providers[state.provider].title }} ‚Ä¢ {{ models[state.model].label }}</span>
            </div>
            <div class="prompt-text rounded-card" id="prompt-preview">
              {{ presets[state.preset_key].prompt | e | replace('\n', '<br>') | safe }}
            </div>
          </section>

          <div class="preset-action">
            <button type="button" class="btn tiny" id="open-preset-modal">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–∫—É</button>
          </div>

        </form>
      </section>
    </main>
  </div>

  <div class="modal-backdrop" id="preset-modal-backdrop">
    <div class="modal-card">
      <div class="modal-header">
        <h3>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–∫—É</h3>
        <button type="button" class="modal-close" id="close-preset-modal">√ó</button>
      </div>
      <form method="post" class="modal-form" id="preset-modal-form">
        <input type="hidden" name="preset" id="modal-preset" value="{{ state.preset_key }}">
        <input type="hidden" name="provider" id="modal-provider" value="{{ state.provider }}">
        <input type="hidden" name="model" id="modal-model" value="{{ state.model }}">
        <input type="hidden" name="temperature" id="modal-temperature" value="{{ '%.2f'|format(state.temperature) }}">

        <div class="field">
          <label for="modal_preset_title">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input
            id="modal_preset_title"
            name="preset_title"
            class="input"
            type="text"
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä ‚Äî –±—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º"
          >
        </div>
        <div class="field">
          <label for="modal_preset_prompt">–¢–µ–∫—Å—Ç –ø—Ä–æ–º–ø—Ç–∞</label>
          <textarea
            id="modal_preset_prompt"
            name="preset_prompt"
            class="input textarea"
            rows="8"
            placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –Ω–æ–≤–æ–π –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–∫–∏"
          >{{ presets[state.preset_key].prompt | trim }}</textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn secondary" id="modal-use-current">–ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–º</button>
          <div class="modal-action-buttons">
            <button type="button" class="btn link" id="modal-cancel">–û—Ç–º–µ–Ω–∞</button>
            <button type="submit" name="action" value="save_preset" class="btn primary small">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script>
    const chatLog = document.getElementById('chat-log');
    if (chatLog) {
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    const presetsData = {{ presets | tojson | safe }};
    const providersData = {{ providers | tojson | safe }};
    const providerSelect = document.getElementById('provider');
    const presetSelect = document.getElementById('preset');
    const modelSelect = document.getElementById('model');
    const temperatureInput = document.getElementById('temperature');

    const composerForm = document.getElementById('composer-form');
    const composerPreset = document.getElementById('composer-preset');
    const composerProvider = document.getElementById('composer-provider');
    const composerModel = document.getElementById('composer-model');
    const composerTemperature = document.getElementById('composer-temperature');
    const composerInput = document.querySelector('.composer-bar-input');

    const promptPreview = document.getElementById('prompt-preview');
    const currentModelBadge = document.querySelector('.current-model');

    const presetModalBackdrop = document.getElementById('preset-modal-backdrop');
    const presetModalForm = document.getElementById('preset-modal-form');
    const openPresetModalBtn = document.getElementById('open-preset-modal');
    const closePresetModalBtn = document.getElementById('close-preset-modal');
    const modalUseCurrentBtn = document.getElementById('modal-use-current');
    const modalPresetInput = document.getElementById('modal-preset');
    const modalProviderInput = document.getElementById('modal-provider');
    const modalModelInput = document.getElementById('modal-model');
    const modalTemperatureInput = document.getElementById('modal-temperature');
    const modalPresetPromptInput = document.getElementById('modal_preset_prompt');

    function formatPromptHTML(text) {
      return text ? text.replace(/\n/g, '<br>') : '';
    }

    function updateModelOptions() {
      if (!providerSelect || !modelSelect) return;
      const providerKey = providerSelect.value;
      const provider = providersData[providerKey] || { models: {} };
      const modelsMap = provider.models || {};
      const previousValue = modelSelect.value;
      let firstValue = null;

      modelSelect.innerHTML = '';
      Object.entries(modelsMap).forEach(([value, meta]) => {
        if (firstValue === null) firstValue = value;
        const option = document.createElement('option');
        option.value = value;
        option.textContent = meta.label || value;
        if (value === previousValue) option.selected = true;
        modelSelect.appendChild(option);
      });

      if (!modelsMap[previousValue] && firstValue) {
        modelSelect.value = firstValue;
      }
    }

    function updatePromptPreview() {
      const preset = presetsData[presetSelect.value];
      if (preset && promptPreview) {
        promptPreview.innerHTML = formatPromptHTML(preset.prompt);
      }
    }

    function updateBadges() {
      if (!currentModelBadge) return;
      const provider = providersData[providerSelect.value] || {};
      const modelsMap = provider.models || {};
      const providerTitle = provider.title || providerSelect.value;
      const modelMeta = modelsMap[modelSelect.value] || {};
      const modelTitle = modelMeta.label || modelSelect.value;
      currentModelBadge.textContent = `${providerTitle} ‚Ä¢ ${modelTitle}`;
    }

    function syncHiddenFields() {
      if (composerPreset) composerPreset.value = presetSelect.value;
      if (composerProvider) composerProvider.value = providerSelect.value;
      if (composerModel) composerModel.value = modelSelect.value;
      if (composerTemperature) composerTemperature.value = temperatureInput.value;

      if (modalPresetInput) modalPresetInput.value = presetSelect.value;
      if (modalProviderInput) modalProviderInput.value = providerSelect.value;
      if (modalModelInput) modalModelInput.value = modelSelect.value;
      if (modalTemperatureInput) modalTemperatureInput.value = temperatureInput.value;
    }

    function syncAll() {
      updateModelOptions();
      updatePromptPreview();
      updateBadges();
      syncHiddenFields();
    }

    if (providerSelect) providerSelect.addEventListener('change', syncAll);
    if (presetSelect) presetSelect.addEventListener('change', syncAll);
    if (modelSelect) modelSelect.addEventListener('change', syncAll);
    if (temperatureInput) temperatureInput.addEventListener('input', syncAll);
    if (composerForm) composerForm.addEventListener('submit', syncHiddenFields);

    function openPresetModal() {
      if (!presetModalBackdrop) return;
      syncAll();
      if (modalPresetPromptInput) {
        const preset = presetsData[presetSelect.value];
        modalPresetPromptInput.value = preset ? preset.prompt : '';
        modalPresetPromptInput.dataset.dirty = '0';
      }
      presetModalBackdrop.classList.add('is-open');
    }

    function closePresetModal() {
      if (presetModalBackdrop) {
        presetModalBackdrop.classList.remove('is-open');
      }
    }

    if (openPresetModalBtn) openPresetModalBtn.addEventListener('click', openPresetModal);
    if (closePresetModalBtn) closePresetModalBtn.addEventListener('click', closePresetModal);
    if (presetModalBackdrop) {
      presetModalBackdrop.addEventListener('click', (event) => {
        if (event.target === presetModalBackdrop) closePresetModal();
      });
    }

    if (modalUseCurrentBtn && modalPresetPromptInput) {
      modalUseCurrentBtn.addEventListener('click', (event) => {
        event.preventDefault();
        const preset = presetsData[presetSelect.value];
        if (preset) {
          modalPresetPromptInput.value = preset.prompt;
          modalPresetPromptInput.dataset.dirty = '0';
        }
      });
    }

    if (modalPresetPromptInput) {
      modalPresetPromptInput.addEventListener('input', () => {
        modalPresetPromptInput.dataset.dirty = '1';
      });
    }

    if (presetModalForm) presetModalForm.addEventListener('submit', syncHiddenFields);

    syncAll();

    function autoResizeTextarea() {
      if (!composerInput) return;
      composerInput.style.height = 'auto';
      const lineHeight = parseInt(window.getComputedStyle(composerInput).lineHeight, 10) || 20;
      const maxHeight = lineHeight * 12;
      composerInput.style.height = Math.min(composerInput.scrollHeight, maxHeight) + 'px';
    }

    if (composerInput) {
      composerInput.addEventListener('input', autoResizeTextarea);
      window.addEventListener('load', autoResizeTextarea);
    }
  </script>
</body>
</html>

